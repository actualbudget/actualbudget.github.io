"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[2677],{1901:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"advanced/scripts/modify-transfers","title":"Identify and Apply Transfers Historically","description":"These SQL scripts modify transactions as to apply transfers historically over migrated data without duplicating transactions. This is useful when you have migrated multiple accounts.","source":"@site/docs/advanced/scripts/modify-transfers.md","sourceDirName":"advanced/scripts","slug":"/advanced/scripts/modify-transfers","permalink":"/docs/advanced/scripts/modify-transfers","draft":false,"unlisted":false,"editUrl":"https://github.com/actualbudget/actual/tree/master/packages/docs/docs/advanced/scripts/modify-transfers.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"SimpleFIN Setup","permalink":"/docs/advanced/bank-sync/simplefin"},"next":{"title":"Reports","permalink":"/docs/reports/"}}');var a=e(31085),i=e(71184);const c={},r="Identify and Apply Transfers Historically",o={},d=[{value:"How To",id:"how-to",level:2}];function l(n){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"identify-and-apply-transfers-historically",children:"Identify and Apply Transfers Historically"})}),"\n",(0,a.jsxs)(t.p,{children:["These SQL scripts modify transactions as to apply ",(0,a.jsx)(t.a,{href:"/docs/transactions/transfers",children:"transfers"})," historically over migrated data without duplicating transactions. This is useful when you have migrated multiple accounts."]}),"\n",(0,a.jsx)(t.admonition,{type:"caution",children:(0,a.jsxs)(t.p,{children:["Before executing any actions, make sure you have a complete ",(0,a.jsx)(t.a,{href:"/docs/backup-restore/backup",children:"backup"}),"."]})}),"\n",(0,a.jsxs)(t.admonition,{type:"note",children:[(0,a.jsx)(t.p,{children:"This process will only apply when the below conditions are met"}),(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"The two transactions are related to different accounts"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["The amounts are exactly the same but inverted e.g. ",(0,a.jsx)(t.code,{children:"-1.00"})," and ",(0,a.jsx)(t.code,{children:"1.00"})]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"The transaction dates are within 3 days of each other"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"The match only occurs once. This means transfers of equal value following the pattern below will not be applied."}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.code,{children:"Account A"})," -> ",(0,a.jsx)(t.code,{children:"Account B"})," -> ",(0,a.jsx)(t.code,{children:"Account A/C"})]}),"\n",(0,a.jsx)(t.p,{children:"As we cannot reliably tell the order of the transfers."}),"\n"]}),"\n"]})]}),"\n",(0,a.jsx)(t.h2,{id:"how-to",children:"How To"}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Create a second copy of the backup"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Extract the backup"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["Open the ",(0,a.jsx)(t.code,{children:"db.sqlite"})," file with your preferred tool ",(0,a.jsx)(t.a,{href:"https://www.sqlite.org/cli.html",children:"SQLite3 cli"}),", ",(0,a.jsx)(t.a,{href:"https://www.heidisql.com/",children:"heidiSQL"}),", etc."]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Run the below query to first view the impacted transactions"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-sql",children:'SELECT t.id,\n    acct,\n    a.name,\n    amount,\n    t.date,\n    imported_description,\n    t.description,\n    t.transferred_id,\n    (\n        SELECT id\n        FROM transactions s\n        WHERE s.tombstone = 0\n            AND s.id != t.id\n            AND starting_balance_flag = 0\n            AND s.amount = (t.amount * -1)\n            AND s.acct != t.acct\n            AND (\n                (\n                    s.date >= t.date\n                    AND s.date <= (t.date + 3)\n                )\n                OR (\n                    s.date <= t.date\n                    AND s.date >= (t.date -3)\n                )\n            )\n    ) AS "transferred_id_new",\n    (\n        SELECT pa.id\n        FROM transactions s\n            LEFT JOIN payees pa ON s.acct = pa.transfer_acct\n        WHERE s.tombstone = 0\n            AND s.id != t.id\n            AND starting_balance_flag = 0\n            AND s.amount = (t.amount * -1)\n            AND s.acct != t.acct\n            AND (\n                (\n                    s.date >= t.date\n                    AND s.date <= (t.date + 3)\n                )\n                OR (\n                    s.date <= t.date\n                    AND s.date >= (t.date -3)\n                )\n            )\n    ) AS "description_new"\nFROM transactions t\n    LEFT JOIN accounts a ON t.acct = a.id\n    LEFT JOIN payees p ON t.description = p.id\n    LEFT JOIN accounts ta ON p.transfer_acct = ta.id\nWHERE t.tombstone = 0\n    AND starting_balance_flag = 0\n    AND (\n        SELECT COUNT(*)\n        FROM transactions s\n        WHERE s.tombstone = 0\n            AND s.id != t.id\n            AND starting_balance_flag = 0\n            AND s.amount = (t.amount * -1)\n            AND s.acct != t.acct\n            AND (\n                (\n                    s.date >= t.date\n                    AND s.date <= (t.date + 3)\n                )\n                OR (\n                    s.date <= t.date\n                    AND s.date >= (t.date -3)\n                )\n            )\n    ) = 1\nORDER BY DATE DESC;\n'})}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Run the below query to update the transactions"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-sql",children:"UPDATE transactions\nSET transferred_id = (\n        SELECT s.id\n        FROM transactions s\n        WHERE s.tombstone = 0\n            AND s.id != transactions.id\n            AND starting_balance_flag = 0\n            AND s.amount = (transactions.amount * -1)\n            AND s.acct != transactions.acct\n            AND (\n                (\n                    s.date >= transactions.date\n                    AND s.date <= (transactions.date + 3)\n                )\n                OR (\n                    s.date <= transactions.date\n                    AND s.date >= (transactions.date -3)\n                )\n            )\n    ),\n    description = (\n        SELECT pa.id\n        FROM transactions s\n            LEFT JOIN payees pa ON s.acct = pa.transfer_acct\n        WHERE s.tombstone = 0\n            AND s.id != transactions.id\n            AND starting_balance_flag = 0\n            AND s.amount = (transactions.amount * -1)\n            AND s.acct != transactions.acct\n            AND (\n                (\n                    s.date >= transactions.date\n                    AND s.date <= (transactions.date + 3)\n                )\n                OR (\n                    s.date <= transactions.date\n                    AND s.date >= (transactions.date -3)\n                )\n            )\n    )\nWHERE tombstone = 0\n    AND starting_balance_flag = 0\n    AND (\n        SELECT COUNT(*)\n        FROM transactions s\n        WHERE s.tombstone = 0\n            AND s.id != transactions.id\n            AND starting_balance_flag = 0\n            AND s.amount = (transactions.amount * -1)\n            AND s.acct != transactions.acct\n            AND (\n                (\n                    s.date >= transactions.date\n                    AND s.date <= (transactions.date + 3)\n                )\n                OR (\n                    s.date <= transactions.date\n                    AND s.date >= (transactions.date -3)\n                )\n            )\n    ) = 1;\n"})}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["Zip the ",(0,a.jsx)(t.code,{children:"db.sqlite"})," file with the original ",(0,a.jsx)(t.code,{children:"metadata.json"})," file"]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["Follow the ",(0,a.jsx)(t.a,{href:"/docs/backup-restore/restore",children:"restore"})," process to apply these into your Actual Server instance"]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Verify your balances are correct and you see the correct transactions marked as transfers!"}),"\n"]}),"\n"]})]})}function h(n={}){const{wrapper:t}={...(0,i.R)(),...n.components};return t?(0,a.jsx)(t,{...n,children:(0,a.jsx)(l,{...n})}):l(n)}},71184:(n,t,e)=>{e.d(t,{R:()=>c,x:()=>r});var s=e(14041);const a={},i=s.createContext(a);function c(n){const t=s.useContext(i);return s.useMemo(function(){return"function"==typeof n?n(t):{...t,...n}},[t,n])}function r(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:c(n.components),s.createElement(i.Provider,{value:t},n.children)}}}]);